---
title: 'ATACCC: duration distributions'
author: "Joshua Blake"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    code_folding: hide
---

```{r setup, include=FALSE}
library(dplyr)
library(GGally)
library(ggdist)
library(ggplot2)
library(purrr)
library(rstan)
library(tidybayes)
library(tidyr)

logit = function(x) log(x) - log(1 - x)
expit = function(x) 1 / (1 + exp(-x))
```

```{r load-dists}
tbl_ataccc_orig = readr::read_csv(
    here::here(
        "../../incidence-from-prevalence/ataccc_sims/2022-02_informative-prior/integration_samples_monte_carlo.csv"
    ),
    show_col_types = FALSE
) |>
    select(.draw, t = d, f, F) |>
    group_by(.draw) |>
    mutate(
        S = c(1, 1 - (lag(F)[-1])),
        lambda = f / S,
    ) |>
    ungroup()
tbl_ataccc_new = readRDS(here::here("duration_samples.rds"))

tbl_ataccc = bind_rows(
    mutate(tbl_ataccc_orig, version = "Original"),
    mutate(tbl_ataccc_new, version = "Updated"),
) |>
    filter(between(t, 1, 30))
```

# Posteriors

```{r ggally-visualise,fig.width=150,fig.height=150}
n_lambdas_to_plot = 30

plot_theme <- theme_bw() + theme(
  axis.text.x = element_text(size = 20, angle = 45, hjust = 1),
  axis.text.y = element_text(size = 20),
  strip.text = element_text(size = 20)
)

p = tbl_ataccc |>
    filter(between(t, 1, n_lambdas_to_plot)) |>
    pivot_wider(id_cols = c(.draw, version), names_from = t, values_from = lambda)  |>
    select(!.draw) |>
    ggpairs(
        columns = 2:(n_lambdas_to_plot+1), # Assuming the first 30 columns are the parameters
        mapping = aes(color = version),
        upper = list(continuous = wrap("autopoint")),
        diag = list(continuous = wrap("densityDiag", alpha = 0.7, size = 1)),
        lower = list(continuous = wrap("autopoint"))
    ) +
    plot_theme
# print(p)
ggsave("pairs.png", p, width = 100, units = "cm",
        height = 100, limitsize = FALSE)

p_logit = tbl_ataccc |>
    filter(between(t, 1, n_lambdas_to_plot)) |>
    pivot_wider(id_cols = c(.draw, version), names_from = t, values_from = lambda)  |>
    select(!.draw) |>
    mutate(across(!version, logit)) |>
    ggpairs(
        columns = 2:(n_lambdas_to_plot+1),
        mapping = aes(color = version),
        # upper = list(continuous = "blank"),
        diag = list(continuous = wrap("densityDiag", alpha = 0.7, size = 1)),
        lower = list(continuous = "autopoint"),
        legend = 2
    ) +
    plot_theme
ggsave("pairs_logit.png", p_logit, width = 100, units = "cm",
        height = 100, limitsize = FALSE)
```


```{r logit-vs-normal}
logit_normal_mean = readRDS("logit_hazard_mean.rds")
logit_normal_cov = readRDS("logit_hazard_cov.rds")
tbl_logit_normal = mvtnorm::rmvnorm(
    1e3,
    mean = logit_normal_mean[1:n_lambdas_to_plot],
    sigma = logit_normal_cov[1:n_lambdas_to_plot,1:n_lambdas_to_plot]
) |>
    as_tibble() |>
    mutate(version = "Normal approx")

tbl_ataccc_updated = tbl_ataccc |>
    filter(between(t, 1, n_lambdas_to_plot), version == "Updated") |>
    pivot_wider(id_cols = c(.draw, version), names_from = t, values_from = lambda)  |>
    select(!.draw) |>
    mutate(across(!version, logit))
    
p_compare_approx = bind_rows(tbl_ataccc_updated, tbl_logit_normal) |>
    ggpairs(
        columns = 2:(n_lambdas_to_plot+1),
        mapping = aes(color = version),
        # upper = list(continuous = "blank"),
        diag = list(continuous = wrap("densityDiag", alpha = 0.7, size = 1)),
        lower = list(continuous = "autopoint"),
        legend = 2
    ) +
    plot_theme
ggsave("pairs_approx.png", p_compare_approx, width = 100, units = "cm",
        height = 100, limitsize = FALSE)
```
